name: PR Check

on:
  pull_request:
    branches: [main, develop]
    types: [opened, synchronize, reopened]

jobs:
  pr-validation:
    name: PRæ¤œè¨¼
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          # PRå…¨å±¥æ­´ã‚’å–å¾—ã—ã¦ã‚³ãƒŸãƒƒãƒˆå±¥æ­´ãƒã‚§ãƒƒã‚¯
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate API types
        run: pnpm generate:api

      - name: ğŸ” Full quality check
        run: pnpm check

      - name: ğŸ—ï¸ Build verification
        run: pnpm build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:3000/api

      - name: ğŸ§ª Test execution
        run: pnpm test --run

      - name: ğŸ“Š Bundle analysis
        run: |
          # Next.js bundleåˆ†æï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
          echo "Bundle analysis would run here"

      - name: ğŸ”’ Security audit
        run: pnpm audit --audit-level moderate
        continue-on-error: true

      - name: âœ… PR validation complete
        run: |
          echo "::notice::All PR checks passed successfully!"
          echo "::notice::Ready for review ğŸš€"

  commit-message-check:
    name: ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ¤œè¨¼
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate commit messages
        run: |
          # PRã®å…¨ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯å½¢å¼ã§ãƒã‚§ãƒƒã‚¯
          echo "Checking commit messages in PR..."

          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰ç¾åœ¨ã®ãƒ–ãƒ©ãƒ³ãƒã¾ã§ã®ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—
          commits=$(git log --pretty=format:"%s" origin/${{ github.base_ref }}..HEAD)

          semantic_pattern='^(feat|fix|docs|style|refactor|perf|test|chore|ci|revert)(\(.+\))?: .{1,50}'

          echo "$commits" | while IFS= read -r commit_msg; do
            if [[ ! "$commit_msg" =~ $semantic_pattern ]]; then
              echo "::error::Invalid commit message format: $commit_msg"
              echo "::error::Please use semantic commit format: <type>(<scope>): <subject>"
              exit 1
            else
              echo "::notice::âœ… Valid commit message: $commit_msg"
            fi
          done
