# 音声インテント仕様（トップページ）

## スコープ

- 対象画面: トップページ（リサーチ開始前のフェーズ）
- 前提: 音声認識トグルが ON の間、連続的に音声イベントが到達する
- 目的: 音声からクエリ最適化を進め、適切なタイミングでリサーチを開始する

## 共通ルール

- セッション単位で状態 (`idle` / `optimizing` / `ready`) を管理し、Intent ハンドラは処理完了後に更新する
- Intent 判定は LLM ベースの分類器が `confidence` スコアを返す想定
- 信頼度に応じた挙動
  - `auto`: 閾値以上の場合は即実行
  - `confirm`: 中間帯はユーザー確認プロンプト（Yes/No を別 Intent で扱う予定）
  - `reject`: 閾値未満は「理解できませんでした」などのフォールバック
- 各 Intent の処理結果はセッションストアを更新し、UI には push 通知（WebSocket/SSE）で反映

## Intent 一覧

| Intent ID                     | 優先度 | 想定発話例                                        | 必要パラメータ                                       | 前提状態                               | 実行アクション                                                                               | 信頼度閾値                                       | 備考                                                               |
| ----------------------------- | ------ | ------------------------------------------------- | ---------------------------------------------------- | -------------------------------------- | -------------------------------------------------------------------------------------------- | ------------------------------------------------ | ------------------------------------------------------------------ |
| `OPTIMIZE_QUERY_APPEND`       | 高     | 「AIの事故例も入れて」「2024年の統計も追加して」  | `partialText`（追加入力）、`modality`(任意)          | `idle` or `optimizing`                 | セッションコンテキストに追記 → クエリ最適化 API を非同期呼び出し                             | auto: ≥0.60 / confirm: 0.40–0.59 / reject: <0.40 | 初回テーマ入力もこの Intent で扱う（セッション側で初回フラグ管理） |
| `START_RESEARCH`              | 高     | 「この候補でリサーチ開始」「パターンAで調査して」 | `candidateId`（省略時は推奨案）、`pattern`（任意）   | `optimizing` or `ready`, 候補が存在    | 候補を確定 → リサーチセッションID発行 → ExecuteResearchUseCase 実行 → `/research/:id` へ遷移 | auto: ≥0.80 / confirm: 0.60–0.79 / reject: <0.60 | 遷移前に最終クエリプレビュー／音声フィードバックを行う             |
| `OPTIMIZE_QUERY_REPLACE`      | 中     | 「別の視点にして」「競合比較に振って」            | `focus`（市場規模/規制/技術など）、`tone`（任意）    | 候補生成済み (`optimizing` or `ready`) | 既存候補を除外条件付きで再生成し、候補リストを全置換                                         | auto: ≥0.65 / confirm: 0.45–0.64 / reject: <0.45 | UI は候補更新を通知し差分ハイライトを再描画                        |
| `CONFIRM_CANDIDATE_SELECTION` | 中     | 「候補2で」「推奨案でいこう」                     | `candidateId` または `rankOrder`、`patternKey`(任意) | 候補が表示中 (`optimizing` or `ready`) | 指定候補を `selectedCandidate` にセットし状態を `ready` へ                                   | auto: ≥0.70 / confirm: 0.50–0.69 / reject: <0.50 | 音声でフィードバックし、UI で選択候補を強調                        |
| `CANCEL_OPTIMIZATION`         | 中     | 「最適化やめて」「初期状態に戻して」              | なし                                                 | `optimizing` or `ready`                | セッションコンテキストを初期化し、状態を `idle` へ戻す                                       | auto: ≥0.70 / confirm: 0.40–0.69 / reject: <0.40 | 候補 UI を閉じ、ガイダンス表示に戻す                               |

## 初回テーマ入力について

- `OPTIMIZE_QUERY_APPEND` の初回呼び出し時に「テーマ未設定」状態を検知し、入力文を初期クエリとして採用する
- UI は初回入力時にヒーロー領域へ大きく表示し、追加入力時は差分ハイライトのみ更新

## 今後の検討事項

- Yes/No など確認用 Intent 群の定義
- リサーチ詳細画面用 Intent セット
- Intent 判定モデルへの学習データ整備と評価指標
- キュー基盤（BullMQ / Redis Streams / SQS 等）の比較と選定
- エラー通知と再試行 UX の詳細設計
