#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit checks..."

# Generate API types if OpenAPI schema changed
if git diff --cached --name-only | grep -q "src/shared/api/schemas/"; then
  echo "ğŸ“¡ OpenAPI schema changed, regenerating API types..."
  pnpm generate:api
  
  # Create index.ts if missing
  if [ ! -f "src/shared/api/generated/index.ts" ]; then
    cat > src/shared/api/generated/index.ts << 'EOF'
/**
 * Generated by orval v7.11.2 ğŸ»
 * Do not edit manually.
 * AI Research POC API
 * OpenAPI spec version: 0.1.0
 */

export * from './api';
export * from './models';
EOF
  fi
  
  git add src/shared/api/generated/
fi

# Auto-fix and run quality checks
echo "ğŸ§¹ Auto-fixing and running quality checks..."
pnpm fix

# Add any files modified by auto-fix
git add .

# Run final type check
pnpm type-check

if [ $? -eq 0 ]; then
  echo "âœ… All checks passed! Proceeding with commit..."
else
  echo "âŒ Type check failed! Please fix the issues and try again."
  exit 1
fi
